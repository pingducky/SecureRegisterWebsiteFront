<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Créer un compte</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/kute.js@2.2.4/dist/kute.min.js"></script>
</head>
<body>
    <div class="login-container" id="container">
        <!-- Avatar avec yeux -->
        <svg id="avatar" width="120" height="100" viewBox="0 0 120 100" style="margin-bottom: 20px;">
            <circle cx="60" cy="50" r="45" fill="#6C63FF" />
            <g id="eye-left" class="eye">
                <circle cx="35" cy="40" r="15" fill="#fff" />
                <circle id="pupil-left" cx="35" cy="40" r="7" fill="#000" />
            </g>
            <g id="eye-right" class="eye">
                <circle cx="85" cy="40" r="15" fill="#fff" />
                <circle id="pupil-right" cx="85" cy="40" r="7" fill="#000" />
            </g>
            <rect x="35" y="70" width="50" height="7" fill="#fff" rx="3" />
        </svg>

        <h2>Créer un compte</h2>

        {% with messages = get_flashed_messages(category_filter=["register_error"]) %}
          {% if messages %}
            <ul class="error-messages">
              {% for message in messages %}
                <li class="error">{{ message }}</li>
              {% endfor %}
            </ul>
          {% endif %}
        {% endwith %}

        <form method="POST">
            <div class="form-group">
                <label>Nom d'utilisateur:</label>
                <input type="text" name="username" id="username" required>
            </div>

            <div class="form-group">
                <label>Mot de passe:</label>
                <input type="password" name="password" id="password" required>
            </div>

            <div id="password-strength-container">
                <progress id="password-strength-bar" value="0" max="60"></progress>
            </div>

            <div id="password-rules">
                <p id="rule-length" class="rule">Au moins 12 caractères</p>
                <p id="rule-uppercase" class="rule">Au moins 1 majuscule</p>
                <p id="rule-digit" class="rule">Au moins 1 chiffre</p>
                <p id="rule-special" class="rule">Au moins 1 caractère spécial</p>
            </div>

            <input type="submit" value="Créer mon compte">
        </form>

        <br>
        <p>Déjà un compte ? <a href="{{ url_for('login') }}">Se connecter</a></p>
    </div>
</body>
</html>
<script>
    // Pupilles qui suivent la souris dans le SVG avatar
    const svg = document.getElementById('avatar');
    const eyes = document.querySelectorAll('.eye');

    let isPasswordFocused = false; // Flag pour savoir si le champ mot de passe est focus

    function movePupils(e) {
        if (isPasswordFocused) return; // On ne suit pas la souris si le mot de passe est focus

        eyes.forEach(eye => {
            const eyeball = eye.querySelector('circle:nth-child(1)');
            const pupil = eye.querySelector('circle:nth-child(2)');

            let cx = +eyeball.getAttribute('cx');
            let cy = +eyeball.getAttribute('cy');
            let rEye = +eyeball.getAttribute('r');
            let rPupil = +pupil.getAttribute('r');

            let pt = svg.createSVGPoint();
            pt.x = e.clientX;
            pt.y = e.clientY;
            let cursor = pt.matrixTransform(svg.getScreenCTM().inverse());

            let dx = cursor.x - cx;
            let dy = cursor.y - cy;
            let angle = Math.atan2(dy, dx);
            let maxDist = rEye - rPupil - 3;
            let dist = Math.min(maxDist, Math.sqrt(dx * dx + dy * dy));

            let px = cx + dist * Math.cos(angle);
            let py = cy + dist * Math.sin(angle);

            pupil.setAttribute('cx', px);
            pupil.setAttribute('cy', py);
        });
    }

    const container = document.getElementById('container');
    container.addEventListener('mousemove', movePupils);

    container.addEventListener('mouseleave', () => {
        if (isPasswordFocused) return; // Pas de reset si le mot de passe est focus
        eyes.forEach(eye => {
            const eyeball = eye.querySelector('circle:nth-child(1)');
            const pupil = eye.querySelector('circle:nth-child(2)');
            pupil.setAttribute('cx', eyeball.getAttribute('cx'));
            pupil.setAttribute('cy', eyeball.getAttribute('cy'));
        });
    });

    const passwordInput = document.getElementById('password');
    const eyeLeft = document.getElementById('eye-left');
    const eyeRight = document.getElementById('eye-right');
    const pupilLeft = document.getElementById('pupil-left');
    const pupilRight = document.getElementById('pupil-right');

    passwordInput.addEventListener('focus', () => {
        isPasswordFocused = true; // Stoppe le suivi de la souris

        // Lève les pupilles vers le haut
        const leftEyeballCy = +eyeLeft.querySelector('circle:nth-child(1)').getAttribute('cy');
        const rightEyeballCy = +eyeRight.querySelector('circle:nth-child(1)').getAttribute('cy');
        const liftAmount = 10;

        pupilLeft.setAttribute('cy', leftEyeballCy - liftAmount);
        pupilRight.setAttribute('cy', rightEyeballCy - liftAmount);
    });

    passwordInput.addEventListener('blur', () => {
        isPasswordFocused = false; // Reprend le suivi de la souris

        const leftEyeball = eyeLeft.querySelector('circle:nth-child(1)');
        const rightEyeball = eyeRight.querySelector('circle:nth-child(1)');

        pupilLeft.setAttribute('cx', leftEyeball.getAttribute('cx'));
        pupilLeft.setAttribute('cy', leftEyeball.getAttribute('cy'));

        pupilRight.setAttribute('cx', rightEyeball.getAttribute('cx'));
        pupilRight.setAttribute('cy', rightEyeball.getAttribute('cy'));
    });

    // --- Gestion de la barre de force du mot de passe ---
    const strengthBar = document.getElementById('password-strength-bar');

    const calculateEntropy = (password) => {
        let charsetSize = 0;
        if (/[a-z]/.test(password)) charsetSize += 26;
        if (/[A-Z]/.test(password)) charsetSize += 26;
        if (/[0-9]/.test(password)) charsetSize += 10;
        if (/[^a-zA-Z0-9]/.test(password)) charsetSize += 32;
        return password.length * Math.log2(charsetSize || 1);
    };

    const setProgressColor = (color) => {
        let styleElement = document.getElementById('progress-bar-style');
        if (styleElement) styleElement.remove();

        styleElement = document.createElement('style');
        styleElement.id = 'progress-bar-style';
        styleElement.innerHTML = `
          #password-strength-bar::-webkit-progress-value {
            background-color: ${color} !important;
          }
        `;
        document.head.appendChild(styleElement);

        strengthBar.style.backgroundColor = color;
    };

    const updateStrengthBar = (entropyValue) => {
        const maxEntropy = 60;
        let normalized = Math.min(entropyValue, maxEntropy);
        let progressValue = Math.pow(normalized / maxEntropy, 3) * maxEntropy;
        strengthBar.value = progressValue;

        if (entropyValue < 45) setProgressColor('red');
        else if (entropyValue < maxEntropy) setProgressColor('orange');
        else setProgressColor('green');
    };

    const serverEntropy = {{ entropy|default(0)|tojson }};
    if (!isNaN(serverEntropy)) updateStrengthBar(serverEntropy);

    passwordInput.addEventListener('input', () => {
        const entropy = calculateEntropy(passwordInput.value);
        updateStrengthBar(entropy);
        validateRules(passwordInput.value);
    });

    // --- Validation des règles ---
    const ruleLength = document.getElementById('rule-length');
    const ruleUppercase = document.getElementById('rule-uppercase');
    const ruleDigit = document.getElementById('rule-digit');
    const ruleSpecial = document.getElementById('rule-special');

    function validateRules(password) {
        ruleLength.classList.toggle('valid', password.length >= 12);
        ruleUppercase.classList.toggle('valid', /[A-Z]/.test(password));
        ruleDigit.classList.toggle('valid', /\d/.test(password));
        ruleSpecial.classList.toggle('valid', /[^a-zA-Z0-9]/.test(password));
    }
</script>

</body>
</html>
